<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsztat Słów</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Outfit:wght@200;300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #0a0a0f;
            --text-primary: #f5f0e8;
            --text-muted: rgba(245, 240, 232, 0.4);
            --accent: #c9a87c;
            --accent-glow: rgba(201, 168, 124, 0.3);
            --danger: #e85454;
            --danger-glow: rgba(232, 84, 84, 0.3);
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100dvh;
            position: relative;
        }

        /* Background */
        .bg-layer {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            transition: opacity 1.5s ease;
        }

        .bg-layer.dimmed {
            opacity: 0.3;
        }

        .bg-gradient {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% 0%, rgba(201, 168, 124, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 50% 100%, rgba(100, 80, 60, 0.06) 0%, transparent 50%),
                var(--bg-deep);
        }

        .floating-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            top: 10%;
            left: -10%;
        }

        .orb-2 {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(150, 120, 100, 0.2) 0%, transparent 70%);
            bottom: 20%;
            right: -5%;
            animation-delay: -7s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -20px) scale(1.05); }
            50% { transform: translate(-20px, 30px) scale(0.95); }
            75% { transform: translate(20px, 20px) scale(1.02); }
        }

        .noise {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.035;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* Container */
        .container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            text-align: center;
            width: 100%;
            max-width: 600px;
            min-height: 100dvh;
        }

        /* Header */
        .header {
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: fadeIn 1s ease-out 0.3s forwards;
            transition: opacity 1s ease, transform 1s ease;
        }

        .header.hidden {
            opacity: 0 !important;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .subtitle {
            font-size: 0.7rem;
            font-weight: 200;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-weight: 300;
            font-style: italic;
            color: var(--accent);
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .title:hover {
            opacity: 0.8;
        }

        .done-counter {
            font-size: 0.65rem;
            font-weight: 200;
            letter-spacing: 0.2em;
            color: var(--text-muted);
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            cursor: pointer;
        }

        .done-counter:hover {
            color: var(--accent);
        }

        .done-counter.visible {
            opacity: 1;
        }

        /* Done modal */
        .done-modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .done-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .done-modal-content {
            background: rgba(20, 20, 25, 0.98);
            border: 1px solid rgba(201, 168, 124, 0.2);
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.4s ease;
        }

        .done-modal.active .done-modal-content {
            transform: translateY(0);
        }

        .done-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(201, 168, 124, 0.1);
        }

        .done-modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 300;
            font-style: italic;
            color: var(--accent);
        }

        .done-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .done-modal-close:hover {
            color: var(--text-primary);
        }

        .done-modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(201, 168, 124, 0.1);
        }

        .done-modal-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .done-modal-tab:hover {
            color: var(--text-primary);
        }

        .done-modal-tab.active {
            color: var(--accent);
            background: rgba(201, 168, 124, 0.1);
        }

        .done-modal-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .done-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .done-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .done-item-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            flex: 1;
            margin-right: 0.5rem;
        }

        .done-item-text.story {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .done-item-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            line-height: 1;
            transition: color 0.3s ease;
            opacity: 0.5;
        }

        .done-item-remove:hover {
            color: var(--danger);
            opacity: 1;
        }

        .done-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
        }

        .tab-count {
            font-size: 0.6rem;
            opacity: 0.6;
        }

        .all-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .all-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .all-item-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            flex: 1;
        }

        .all-item-text.story {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .all-item.done .all-item-text {
            color: var(--accent);
        }

        .all-item.done .all-item-text::after {
            content: ' ✓';
            opacity: 0.8;
        }

        .all-item-toggle {
            background: none;
            border: 1px solid rgba(201, 168, 124, 0.2);
            color: var(--text-muted);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .all-item-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .all-item.done .all-item-toggle {
            color: var(--text-muted);
            opacity: 0.6;
        }

        .all-item.done .all-item-toggle:hover {
            opacity: 1;
        }

        .all-item.done .all-item-text::after {
            display: none;
        }

        /* Mode toggle */
        .mode-toggle {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            padding: 0.25rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(201, 168, 124, 0.15);
            border-radius: 4px;
            opacity: 0;
            animation: fadeIn 1s ease-out 0.4s forwards;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .mode-toggle.hidden {
            opacity: 0 !important;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .mode-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem;
            font-weight: 300;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .mode-tab:hover {
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: rgba(201, 168, 124, 0.15);
            color: var(--accent);
        }

        /* Intro info */
        .intro-info {
            max-width: 320px;
            margin-bottom: 2rem;
            opacity: 0;
            animation: fadeIn 1s ease-out 0.5s forwards;
            transition: opacity 0.8s ease, transform 0.8s ease, max-height 0.8s ease;
            max-height: 300px;
            overflow: hidden;
        }

        .intro-info.hidden {
            opacity: 0 !important;
            transform: translateY(-10px);
            pointer-events: none;
            max-height: 0;
            margin-bottom: 0;
        }

        .intro-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-style: italic;
        }

        .intro-text strong {
            color: var(--accent);
            font-weight: 400;
        }

        .intro-features {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            text-align: left;
        }

        .intro-feature {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.5;
            text-align: left;
        }

        .intro-icon {
            color: var(--accent);
            opacity: 0.6;
            font-size: 0.6rem;
            margin-top: 0.2rem;
        }

        /* Word display - always visible */
        .word-stage {
            position: relative;
            width: 100%;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            transition: all 1s ease;
        }

        .word-stage.compact {
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .word-container {
            position: relative;
            padding: 1rem 2rem;
        }

        .frame {
            position: absolute;
            inset: -20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .frame.visible { opacity: 1; }

        .frame-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: var(--accent);
            border-style: solid;
            border-width: 0;
            opacity: 0.3;
        }

        .frame-corner.tl { top: 0; left: 0; border-top-width: 1px; border-left-width: 1px; }
        .frame-corner.tr { top: 0; right: 0; border-top-width: 1px; border-right-width: 1px; }
        .frame-corner.bl { bottom: 0; left: 0; border-bottom-width: 1px; border-left-width: 1px; }
        .frame-corner.br { bottom: 0; right: 0; border-bottom-width: 1px; border-right-width: 1px; }

        .word {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2.2rem, 10vw, 4rem);
            font-weight: 300;
            letter-spacing: 0.05em;
            color: var(--text-primary);
            text-transform: lowercase;
            position: relative;
        }

        .word-inner {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            filter: blur(8px);
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1),
                        transform 0.8s cubic-bezier(0.16, 1, 0.3, 1),
                        filter 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .word-inner.revealed {
            opacity: 1;
            transform: translateY(0);
            filter: blur(0);
        }

        .word-inner.hiding {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            filter: blur(8px);
        }

        .word-inner.story-mode {
            font-size: clamp(1rem, 4vw, 1.4rem);
            line-height: 1.6;
            max-width: 90vw;
            text-align: center;
            text-transform: none;
        }

        .word-stage.story-active {
            min-height: 180px;
        }

        .word-glow {
            position: absolute;
            inset: -50px;
            background: radial-gradient(ellipse at center, var(--accent-glow) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none;
            z-index: -1;
        }

        .word-glow.active { opacity: 1; }

        .placeholder {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-style: italic;
            color: var(--text-muted);
        }

        .placeholder.hidden { display: none; }

        .particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: visible;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
        }

        @keyframes particleBurst {
            0% { opacity: 0.8; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        /* Controls area */
        .controls {
            width: 100%;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 1s ease, transform 1s ease;
        }

        .controls.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
        }

        /* Mode buttons row */
        .mode-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* Action area - below word */
        .action-area {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: opacity 1s ease;
        }

        .action-area.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Buttons */
        .btn {
            position: relative;
            padding: 0.9rem 2rem;
            background: transparent;
            border: 1px solid rgba(201, 168, 124, 0.3);
            color: var(--accent);
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 300;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(201, 168, 124, 0.15);
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-text {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.9rem 1.2rem;
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .btn.active {
            border-color: var(--accent);
            background: rgba(201, 168, 124, 0.15);
            box-shadow: 0 0 20px rgba(201, 168, 124, 0.2);
        }

        .btn.active.done-active {
            border-color: rgba(201, 168, 124, 0.8);
            background: rgba(201, 168, 124, 0.2);
            color: var(--accent);
            box-shadow: 0 0 20px rgba(201, 168, 124, 0.3);
            opacity: 1;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn:disabled.done-active {
            opacity: 1;
            cursor: default;
        }

        .btn:disabled:hover {
            border-color: rgba(201, 168, 124, 0.3);
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn-danger {
            border-color: rgba(232, 84, 84, 0.3);
            color: var(--danger);
        }

        .btn-danger:hover {
            border-color: var(--danger);
            box-shadow: 0 0 30px var(--danger-glow);
        }

        .btn-danger::before {
            background: linear-gradient(90deg, transparent, var(--danger-glow), transparent);
        }

        .btn-small {
            padding: 0.6rem 1rem;
            font-size: 0.65rem;
        }

        /* ========== WRITING MODE ========== */
        .writing-panel {
            display: none;
            flex-direction: column;
            width: 100%;
            flex: 1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .writing-panel.active {
            display: flex;
            opacity: 1;
        }

        .writing-setup {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 2rem 0;
        }

        .writing-setup.hidden {
            display: none;
        }

        .time-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 280px;
        }

        .time-label {
            font-size: 0.7rem;
            font-weight: 200;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .time-display {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .time-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 300;
            color: var(--accent);
            line-height: 1;
            min-width: 2ch;
            text-align: center;
        }

        .time-unit {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-style: italic;
            color: var(--text-muted);
        }

        .slider-container {
            width: 100%;
            position: relative;
            padding: 0.5rem 0;
        }

        .time-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, 
                var(--accent) 0%, 
                var(--accent) var(--slider-progress, 0%), 
                rgba(201, 168, 124, 0.2) var(--slider-progress, 0%), 
                rgba(201, 168, 124, 0.2) 100%);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--bg-deep);
            border: 2px solid var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .time-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--bg-deep);
            border: 2px solid var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .time-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        .time-slider::-moz-range-track {
            background: transparent;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding: 0 2px;
        }

        .slider-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            opacity: 0.5;
        }

        .writing-editor {
            display: none;
            flex-direction: column;
            width: 100%;
            flex: 1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .writing-editor.active {
            display: flex;
            opacity: 1;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
            opacity: 0.6;
            transition: opacity 0.5s ease;
        }

        .timer-display {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--accent);
            letter-spacing: 0.1em;
        }

        .word-count {
            font-size: 0.65rem;
            color: var(--text-muted);
            letter-spacing: 0.1em;
        }

        .editor-area {
            position: relative;
            flex: 1;
            min-height: 250px;
        }

        .editor-textarea {
            width: 100%;
            height: 100%;
            min-height: 250px;
            padding: 1.5rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(201, 168, 124, 0.1);
            color: var(--text-primary);
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.15rem;
            line-height: 1.9;
            resize: none;
            outline: none;
            transition: border-color 0.5s ease, color 0.5s ease, opacity 0.5s ease;
        }

        .editor-textarea:focus {
            border-color: rgba(201, 168, 124, 0.2);
        }

        .editor-textarea::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Gradual color transition for idle */
        .editor-textarea {
            --idle-progress: 0;
            color: color-mix(in srgb, var(--text-primary) calc(100% - var(--idle-progress) * 100%), var(--danger) calc(var(--idle-progress) * 100%));
        }

        .editor-textarea.fading {
            opacity: calc(1 - var(--idle-progress) * 0.8);
        }

        .danger-indicator {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--danger);
            opacity: 0;
            transition: opacity 0.5s ease;
            letter-spacing: 0.1em;
        }

        .danger-indicator.visible {
            opacity: 1;
        }

        /* Progress dots */
        .progress-dots {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem;
            min-height: 20px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            animation: dotAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            box-shadow: 0 0 12px var(--accent-glow);
        }

        @keyframes dotAppear {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                transform: scale(1.4);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .progress-dot:nth-child(5n) {
            width: 10px;
            height: 10px;
            box-shadow: 0 0 16px var(--accent-glow);
        }

        .writing-complete {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
            padding: 2rem 0;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .writing-complete.active {
            display: flex;
            opacity: 1;
        }

        .complete-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            color: var(--accent);
            font-style: italic;
        }

        .complete-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.8;
        }

        .saved-text-preview {
            width: 100%;
            max-height: 180px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(201, 168, 124, 0.1);
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
            color: var(--text-muted);
        }

        .complete-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ========== RECORDING MODE ========== */
        .recording-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 1.5rem;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .recording-panel.active {
            display: flex;
            opacity: 1;
        }

        .mic-visualizer {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid rgba(201, 168, 124, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }

        .mic-visualizer.recording {
            border-color: var(--danger);
            box-shadow: 0 0 40px var(--danger-glow);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .mic-visualizer.paused {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            animation: none;
        }

        .mic-visualizer.paused svg {
            stroke: var(--accent);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .mic-visualizer svg {
            width: 36px;
            height: 36px;
            stroke: var(--accent);
            stroke-width: 1.5;
            fill: none;
            transition: stroke 0.5s ease;
        }

        .mic-visualizer.recording svg {
            stroke: var(--danger);
        }

        .recording-timer {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            color: var(--text-primary);
            letter-spacing: 0.1em;
        }

        .recordings-list-section {
            width: 100%;
            margin-top: 1rem;
        }

        .recordings-header {
            font-size: 0.6rem;
            font-weight: 200;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .recordings-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 180px;
            overflow-y: auto;
        }

        .recording-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.7rem 0.9rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .recording-item:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(201, 168, 124, 0.2);
        }

        .recording-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .recording-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .recording-date {
            font-size: 0.55rem;
            color: var(--text-muted);
        }

        .recording-actions {
            display: flex;
            gap: 0.3rem;
        }

        .btn-tiny {
            padding: 0.4rem 0.5rem;
            background: transparent;
            border: 1px solid rgba(201, 168, 124, 0.2);
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .btn-tiny:hover {
            background: rgba(201, 168, 124, 0.1);
            border-color: var(--accent);
        }

        .btn-tiny svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .no-recordings {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }

        /* Saved writings */
        .saved-writings {
            width: 100%;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(201, 168, 124, 0.1);
            display: none;
        }

        .saved-writings.has-items {
            display: block;
        }

        .writing-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            padding: 0.8rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .writing-item:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(201, 168, 124, 0.2);
        }

        .writing-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .writing-item-word {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: var(--accent);
            font-style: italic;
        }

        .writing-item-word.done::after {
            content: ' ✓';
            color: var(--accent);
            opacity: 0.8;
        }

        .writing-item-meta {
            font-size: 0.55rem;
            color: var(--text-muted);
        }

        .writing-item-preview {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .writing-item-actions {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }

        /* Done word indicator on main display */
        .word-inner.done::after {
            content: ' ✓';
            font-size: 0.6em;
            color: var(--accent);
            opacity: 0.8;
            vertical-align: super;
        }

        /* Utilities */
        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @supports (padding: env(safe-area-inset-bottom)) {
            .container {
                padding-bottom: calc(2rem + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="bg-layer" id="bg-layer">
        <div class="bg-gradient"></div>
        <div class="floating-orb orb-1"></div>
        <div class="floating-orb orb-2"></div>
    </div>
    <div class="noise"></div>

    <div class="container">
        <header class="header" id="header">
            <p class="subtitle">warsztat</p>
            <h1 class="title">Słów</h1>
            <p class="done-counter" id="done-counter"></p>
        </header>

        <!-- Done items modal -->
        <div class="done-modal" id="done-modal">
            <div class="done-modal-content">
                <div class="done-modal-header">
                    <h3 class="done-modal-title">Załatwione</h3>
                    <button class="done-modal-close" id="done-modal-close">×</button>
                </div>
                <div class="done-modal-tabs">
                    <button class="done-modal-tab active" data-tab="words">Słowa</button>
                    <button class="done-modal-tab" data-tab="stories">Historie</button>
                </div>
                <div class="done-modal-list" id="done-words-list"></div>
                <div class="done-modal-list" id="done-stories-list" style="display: none;"></div>
            </div>
        </div>

        <!-- All items modal -->
        <div class="done-modal" id="all-items-modal">
            <div class="done-modal-content" style="max-height: 80vh;">
                <div class="done-modal-header">
                    <h3 class="done-modal-title">Wszystkie hasła</h3>
                    <button class="done-modal-close" id="all-items-modal-close">×</button>
                </div>
                <div class="done-modal-tabs">
                    <button class="done-modal-tab active" data-tab="all-words">Słowa <span class="tab-count" id="words-count"></span></button>
                    <button class="done-modal-tab" data-tab="all-stories">Historie <span class="tab-count" id="stories-count"></span></button>
                </div>
                <div class="done-modal-list" id="all-words-list"></div>
                <div class="done-modal-list" id="all-stories-list" style="display: none;"></div>
            </div>
        </div>

        <!-- Mode toggle -->
        <div class="mode-toggle" id="mode-toggle">
            <button class="mode-tab active" id="mode-words" data-mode="words">Słowa</button>
            <button class="mode-tab" id="mode-stories" data-mode="stories">Historie</button>
        </div>

        <!-- Info section - visible before first word -->
        <div class="intro-info" id="intro-info">
            <p class="intro-text">Wylosuj słowo, a następnie <strong>pisz</strong> lub <strong>nagrywaj</strong> swoje myśli.</p>
            <div class="intro-features">
                <div class="intro-feature">
                    <span class="intro-icon">✦</span>
                    <span>Pisanie na czas z motywacją do ciągłego pisania</span>
                </div>
                <div class="intro-feature">
                    <span class="intro-icon">✦</span>
                    <span>Nagrywanie głosu z możliwością pobrania</span>
                </div>
                <div class="intro-feature">
                    <span class="intro-icon">✦</span>
                    <span>Wszystko zostaje w Twojej przeglądarce — nic nie jest wysyłane</span>
                </div>
            </div>
        </div>

        <!-- Word always visible -->
        <div class="word-stage" id="word-stage">
            <div class="word-container">
                <div class="word-glow" id="word-glow"></div>
                <div class="frame" id="frame">
                    <div class="frame-corner tl"></div>
                    <div class="frame-corner tr"></div>
                    <div class="frame-corner bl"></div>
                    <div class="frame-corner br"></div>
                </div>
                <div class="particles" id="particles"></div>
                <div class="word">
                    <span class="word-inner" id="word-inner"></span>
                </div>
            </div>
        </div>

        <!-- Controls - hidden during writing -->
        <div class="controls" id="controls">
            <div class="mode-buttons">
                <button class="btn" id="drawBtn">
                    <span class="btn-text">Losuj</span>
                </button>
                <button class="btn btn-icon" id="speakBtn" title="Automatyczne czytanie">
                    <span class="btn-text">
                        <svg viewBox="0 0 24 24">
                            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                        </svg>
                    </span>
                </button>
            </div>

            <div class="mode-buttons" id="action-buttons" style="display: none;">
                <button class="btn" id="writeBtn">
                    <span class="btn-text">Pisz</span>
                </button>
                <button class="btn" id="recordModeBtn">
                    <span class="btn-text">Nagraj</span>
                </button>
                <button class="btn btn-icon" id="markDoneMainBtn" title="Oznacz jako załatwione">
                    <span class="btn-text">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </span>
                </button>
            </div>
        </div>

        <!-- Writing Panel -->
        <div class="writing-panel" id="writing-panel">
            <div class="writing-setup" id="writing-setup">
                <div class="time-selector">
                    <label class="time-label">Czas pisania</label>
                    <div class="time-display">
                        <span class="time-value" id="time-value">5</span>
                        <span class="time-unit">minut</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="time-slider" id="writing-time" min="1" max="10" value="5">
                        <div class="slider-labels">
                            <span class="slider-label">1</span>
                            <span class="slider-label">5</span>
                            <span class="slider-label">10</span>
                        </div>
                    </div>
                </div>
                <div class="mode-buttons">
                    <button class="btn" id="start-writing-btn">
                        <span class="btn-text">Zacznij</span>
                    </button>
                    <button class="btn btn-small" id="cancel-writing-btn">
                        <span class="btn-text">Anuluj</span>
                    </button>
                </div>
            </div>

            <div class="writing-editor" id="writing-editor">
                <div class="editor-header">
                    <span class="timer-display" id="writing-timer">05:00</span>
                    <span class="word-count" id="word-count">0 słów</span>
                </div>
                <div class="editor-area">
                    <textarea class="editor-textarea" id="editor-textarea" placeholder="Zacznij pisać..."></textarea>
                    <div class="danger-indicator" id="danger-indicator">Pisz! Tekst zaraz zniknie...</div>
                </div>
                <div class="progress-dots" id="writing-dots"></div>
            </div>

            <div class="writing-complete" id="writing-complete">
                <h2 class="complete-title">Ukończono</h2>
                <div class="complete-stats" id="complete-stats"></div>
                <div class="saved-text-preview" id="saved-text-preview"></div>
                <div class="complete-buttons">
                    <button class="btn btn-small" id="copy-text-btn">
                        <span class="btn-text">Kopiuj</span>
                    </button>
                    <button class="btn btn-small" id="save-text-btn">
                        <span class="btn-text">Zapisz</span>
                    </button>
                    <button class="btn btn-small" id="mark-done-btn">
                        <span class="btn-text">✓ Załatwione</span>
                    </button>
                </div>
                <div class="complete-buttons" style="margin-top: 0.75rem;">
                    <button class="btn btn-small" id="new-session-btn">
                        <span class="btn-text">Nowa sesja</span>
                    </button>
                    <button class="btn btn-small" id="back-to-word-btn">
                        <span class="btn-text">Powrót</span>
                    </button>
                </div>
            </div>

            <!-- Saved writings list -->
            <div class="saved-writings" id="saved-writings">
                <p class="recordings-header">Zapisane teksty</p>
                <div class="recordings-list" id="writings-list"></div>
            </div>
        </div>

        <!-- Recording Panel -->
        <div class="recording-panel" id="recording-panel">
            <div class="mic-visualizer" id="mic-visualizer">
                <svg viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            </div>
            <div class="recording-timer" id="recording-timer">00:00</div>
            <div class="progress-dots" id="recording-dots"></div>
            <div class="mode-buttons">
                <button class="btn btn-danger" id="record-btn">
                    <span class="btn-text">Nagraj</span>
                </button>
                <button class="btn btn-icon" id="pause-btn" style="display: none;" title="Pauza">
                    <span class="btn-text">
                        <svg viewBox="0 0 24 24" id="pause-icon">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                    </span>
                </button>
                <button class="btn btn-small" id="back-from-record-btn">
                    <span class="btn-text">Powrót</span>
                </button>
            </div>

            <div class="recordings-list-section" id="recordings-list-section">
                <p class="recordings-header">Twoje nagrania</p>
                <div class="recordings-list" id="recordings-list">
                    <p class="no-recordings">Brak nagrań</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let currentWord = '';
        let autoSpeak = false;
        let isAnimating = false;
        let currentMode = 'word'; // word, writing, recording
        let savedWritings = [];
        let doneWords = new Set();
        let doneStories = new Set();
        let currentWritingText = ''; // Store current text for saving

        // ========== ELEMENTS ==========
        const bgLayer = document.getElementById('bg-layer');
        const header = document.getElementById('header');
        const wordStage = document.getElementById('word-stage');
        const wordInner = document.getElementById('word-inner');
        const wordGlow = document.getElementById('word-glow');
        const frame = document.getElementById('frame');
        const introInfo = document.getElementById('intro-info');
        const particles = document.getElementById('particles');
        const controls = document.getElementById('controls');
        const actionButtons = document.getElementById('action-buttons');
        const drawBtn = document.getElementById('drawBtn');
        const speakBtn = document.getElementById('speakBtn');
        const writeBtn = document.getElementById('writeBtn');
        const recordModeBtn = document.getElementById('recordModeBtn');
        const markDoneMainBtn = document.getElementById('markDoneMainBtn');

        // ========== WORDS ==========
        const words = [
            'przyjaźń', 'wstyd', 'tęsknota', 'radość', 'smutek', 
            'nadzieja', 'strach', 'miłość', 'gniew', 'spokój',
            'zazdrość', 'duma', 'wdzięczność', 'samotność', 'ekscytacja',
            'melancholia', 'euforia', 'nostalgia', 'czułość', 'rezygnacja',
            'podróż', 'sen', 'cisza', 'burza', 'świt',
            'zmierzch', 'echo', 'cień', 'światło', 'mgła',
            'deszcz', 'wiatr', 'płomień', 'fala', 'przestrzeń',
            'czas', 'wieczność', 'chwila', 'przemiana', 'początek',
            'wolność', 'prawda', 'piękno', 'odwaga', 'mądrość',
            'siła', 'łagodność', 'harmonia', 'chaos', 'równowaga',
            'intuicja', 'wyobraźnia', 'ciekawość', 'cierpliwość', 'spontaniczność',
            'autentyczność', 'wrażliwość', 'kreatywność', 'determinacja', 'akceptacja',
            'bliskość', 'zaufanie', 'lojalność', 'empatia', 'wspólnota',
            'dialog', 'granica', 'połączenie', 'rozłąka', 'pojednanie',
            'troska', 'wsparcie', 'obecność', 'nieobecność', 'pamięć',
            'ocean', 'góra', 'las', 'pustynia', 'niebo',
            'gwiazda', 'księżyc', 'horyzont', 'otchłań', 'źródło',
            'rzeka', 'korzeń', 'kwiat', 'nasiono', 'gleba',
            'wzrost', 'zanikanie', 'rozkwit', 'odrodzenie', 'spełnienie',
            'poszukiwanie', 'odkrycie', 'utrata', 'powrót', 'wędrówka'
        ];

        // Story starters
        const storyStarters = [
            // Oryginalne
            'Kiedy otworzyła drzwi, zobaczyła coś, czego się nie spodziewała.',
            'List przyszedł dokładnie dziesięć lat po jej zniknięciu.',
            'Zegar na wieży wybił północ, a miasto zamarło.',
            'Nie pamiętał swojego imienia, ale pamiętał jej twarz.',
            'Ostatni pociąg odjechał godzinę temu.',
            'W lustrze odbijał się ktoś zupełnie inny.',
            'Znalazła klucz w kieszeni płaszcza, którego nigdy nie nosiła.',
            'Deszcz padał nieprzerwanie od czterdziestu dni.',
            'Telefon zadzwonił o trzeciej w nocy.',
            'Na stole leżała kartka z jednym słowem.',
            'Wróciła do domu po dwudziestu latach nieobecności.',
            'Światło w latarni morskiej zgasło po raz pierwszy od stu lat.',
            'Ostatnie słowa babci brzmiały zagadkowo.',
            'Obudziła się w pokoju, którego nie rozpoznawała.',
            'Fotografia wypadła ze starej książki.',
            'Nikt nie wiedział, skąd wzięło się dziecko na progu.',
            'Muzyka dobiegała zza zamkniętych drzwi.',
            'Spotkali się przypadkiem po piętnastu latach.',
            'W ogrodzie wyrósł kwiat, jakiego nikt wcześniej nie widział.',
            'Znalazł pamiętnik w murze starego domu.',
            // Nowe
            'Znalazła swoje dziecięce zdjęcie w antykwariacie, z datą sprzed stu lat.',
            'Tego dnia postanowiła, że strach nie będzie już podejmował za nią decyzji.',
            'Pierwszy krok był najtrudniejszy, więc zrobiła go boso.',
            'W tej rodzinie kobiety płakały tylko z radości.',
            'Od pokoleń kobiety w jej rodzinie rodziły się z mapą na dłoni, prowadzącą do miejsca, gdzie będą szczęśliwe.',
            'Stary dąb zrzucał liście zawsze, gdy w rodzinie ktoś zapominał o swoich korzeniach.',
            'Od tygodnia słyszała w rozmowach przypadkowych przechodniów to samo zdanie.',
            'Miała sześćdziesiąt lat, kiedy pierwszy raz w życiu powiedziała to głośno.',
            'Obudziła się z przekonaniem, że ta rekordowo długa zima wreszcie się skończyła.',
            'Wyrzuciła listę rzeczy, które „powinna" zrobić, i napisała listę rzeczy, które ją zachwycają.',
            'Przestała czekać na pozwolenie i sama sobie je wypisała.',
            'Babcia twierdziła, że herbata parzona podczas burzy smakuje wspomnieniami.',
            'Do każdej blizny opowiadała historię przetrwania, nie porażki.',
            'Jej dziadek miał kolekcję zepsutych zegarów, w której każdy wskazywał inną godzinę.',
            'Miał 80 lat i dla niej poszedł na pierwszą w życiu lekcję tańca.',
            'Pola zaatakowała plaga najpiękniejszych motyli, jakie kiedykolwiek widział świat.',
            'Pierwszą decyzją po powrocie do rodzinnego domu było wynajęcie buldożera.',
            'W skrzynce pocztowej znalazła list od siebie samej, którego wysłania nie pamiętała.',
            'W dniu jego pogrzebu wszystkie ptaki w miasteczku zamilkły.',
            'Kot wrócił po siedmiu latach nieobecności.',
            'Znalazła w kieszeni płaszcza bilet na pociąg, który odjeżdża jutro o świcie.',
            'Nagle babcia zaczęła mówić w języku, którego nikt w rodzinie nie znał.',
            'Na strychu odkryła walizkę spakowaną na wyjazd, który nigdy się nie odbył.',
            'Po śmierci dziadka okazało się, że przez pięćdziesiąt lat codziennie pisał wiersz dla kogoś innego.',
            'Tego dnia każdy człowiek na Ziemi stracił jeden zmysł.',
            'Okazało się, że prawie wszyscy mieszkańcy tego kraju byli kosmitami.',
            'Kiedy pierwszy raz zaprezentowano to urządzenie, nikt nie podejrzewał, że tak bardzo zmieni ono losy ludzkości.',
            'To chyba piosenka o mnie, pomyślała, słuchając najnowszej listy przebojów.',
            'Być może to było o jeden krok za daleko, ale było już za późno.',
            'Do jej mieszkania wleciał bardzo dziwny smok.'
        ];

        const drawnWords = new Set();
        const drawnStories = new Set();
        let currentAppMode = 'words'; // 'words' or 'stories'

        function getRandomWord() {
            // Filter out both drawn and done words
            const available = words.filter(w => !drawnWords.has(w) && !doneWords.has(w));
            if (available.length === 0) {
                // If all words are done or drawn, only reset drawn (not done)
                drawnWords.clear();
                const stillAvailable = words.filter(w => !doneWords.has(w));
                if (stillAvailable.length === 0) {
                    // All words are done - show message
                    return null;
                }
                return stillAvailable[Math.floor(Math.random() * stillAvailable.length)];
            }
            return available[Math.floor(Math.random() * available.length)];
        }

        function getRandomStory() {
            const available = storyStarters.filter(s => !drawnStories.has(s) && !doneStories.has(s));
            if (available.length === 0) {
                drawnStories.clear();
                const stillAvailable = storyStarters.filter(s => !doneStories.has(s));
                if (stillAvailable.length === 0) {
                    return null; // All stories done
                }
                return stillAvailable[Math.floor(Math.random() * stillAvailable.length)];
            }
            return available[Math.floor(Math.random() * available.length)];
        }

        // ========== SAVED WRITINGS & DONE WORDS ==========
        function loadSavedWritings() {
            try {
                const saved = localStorage.getItem('workshopWritings');
                if (saved) {
                    savedWritings = JSON.parse(saved);
                }
                const done = localStorage.getItem('workshopDoneWords');
                if (done) {
                    doneWords = new Set(JSON.parse(done));
                }
                const doneS = localStorage.getItem('workshopDoneStories');
                if (doneS) {
                    doneStories = new Set(JSON.parse(doneS));
                }
                renderSavedWritings();
                updateDoneCounter();
            } catch (e) {
                console.error('Error loading writings:', e);
            }
        }

        function updateDoneCounter() {
            const counter = document.getElementById('done-counter');
            if (!counter) return;
            
            if (currentAppMode === 'stories') {
                const count = doneStories.size;
                const total = storyStarters.length;
                
                if (count > 0) {
                    counter.textContent = `${count} / ${total} ✓`;
                    counter.classList.add('visible');
                } else {
                    counter.classList.remove('visible');
                }
            } else {
                const count = doneWords.size;
                const total = words.length;
                
                if (count > 0) {
                    counter.textContent = `${count} / ${total} ✓`;
                    counter.classList.add('visible');
                } else {
                    counter.classList.remove('visible');
                }
            }
        }

        function saveSavedWritings() {
            try {
                localStorage.setItem('workshopWritings', JSON.stringify(savedWritings));
                localStorage.setItem('workshopDoneWords', JSON.stringify([...doneWords]));
                localStorage.setItem('workshopDoneStories', JSON.stringify([...doneStories]));
            } catch (e) {
                console.error('Error saving writings:', e);
            }
        }

        function renderSavedWritings() {
            const list = document.getElementById('writings-list');
            const container = document.getElementById('saved-writings');
            
            if (!list || !container) return;
            
            if (savedWritings.length === 0) {
                container.classList.remove('has-items');
                return;
            }
            
            container.classList.add('has-items');
            list.innerHTML = savedWritings.map((w, i) => `
                <div class="writing-item">
                    <div class="writing-item-header">
                        <span class="writing-item-word ${doneWords.has(w.word) ? 'done' : ''}">${w.word}</span>
                        <span class="writing-item-meta">${w.date} · ${w.wordCount} słów</span>
                    </div>
                    <div class="writing-item-preview">${w.text.substring(0, 150)}${w.text.length > 150 ? '...' : ''}</div>
                    <div class="writing-item-actions">
                        <button class="btn-tiny" onclick="continueWriting(${i})" title="Dopisz">
                            <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </button>
                        <button class="btn-tiny" onclick="copyWriting(${i})" title="Kopiuj">
                            <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>
                        <button class="btn-tiny" onclick="deleteWriting(${i})" title="Usuń">
                            <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.continueWriting = function(index) {
            const writing = savedWritings[index];
            if (!writing) return;
            
            // Set the word and enter writing mode
            currentWord = writing.word;
            wordInner.textContent = currentWord;
            wordInner.classList.add('revealed');
            if (doneWords.has(currentWord)) {
                wordInner.classList.add('done');
            }
            wordGlow.classList.add('active');
            frame.classList.add('visible');
            actionButtons.style.display = 'flex';
            updateDoneButtonState();
            
            // Enter writing mode with existing text
            enterWritingMode();
            
            // Pre-fill with existing text after a short delay
            setTimeout(() => {
                editorTextarea.value = writing.text + '\n\n';
                editorTextarea.focus();
                editorTextarea.setSelectionRange(editorTextarea.value.length, editorTextarea.value.length);
                updateWordCount();
            }, 600);
        };

        window.copyWriting = function(index) {
            const writing = savedWritings[index];
            if (writing) {
                navigator.clipboard.writeText(writing.text);
            }
        };

        window.deleteWriting = function(index) {
            savedWritings.splice(index, 1);
            saveSavedWritings();
            renderSavedWritings();
        };

        function saveCurrentWriting() {
            if (!currentWritingText.trim()) return;
            
            // Check if we have an existing entry for this word
            const existingIndex = savedWritings.findIndex(w => w.word === currentWord);
            
            const wordCount = currentWritingText.trim().split(/\s+/).length;
            const entry = {
                word: currentWord,
                text: currentWritingText,
                date: new Date().toLocaleDateString('pl-PL'),
                wordCount: wordCount
            };
            
            if (existingIndex >= 0) {
                // Update existing
                savedWritings[existingIndex] = entry;
            } else {
                // Add new
                savedWritings.unshift(entry);
            }
            
            saveSavedWritings();
            renderSavedWritings();
            
            // Feedback
            const btn = document.getElementById('save-text-btn');
            if (btn) {
                btn.querySelector('.btn-text').textContent = 'Zapisano!';
                setTimeout(() => {
                    btn.querySelector('.btn-text').textContent = 'Zapisz';
                }, 2000);
            }
        }

        function markWordAsDone() {
            if (!currentWord) return;
            
            if (currentAppMode === 'stories') {
                doneStories.add(currentWord);
            } else {
                doneWords.add(currentWord);
            }
            saveSavedWritings();
            
            // Update UI
            wordInner.classList.add('done');
            renderSavedWritings();
            updateDoneButtonState();
            updateDoneCounter();
            
            // Feedback for complete screen button
            const btn = document.getElementById('mark-done-btn');
            if (btn) {
                btn.querySelector('.btn-text').textContent = '✓ Załatwione!';
                btn.disabled = true;
            }
        }

        function updateDoneButtonState() {
            if (!markDoneMainBtn) return;
            
            const isDone = currentAppMode === 'stories' 
                ? doneStories.has(currentWord) 
                : doneWords.has(currentWord);
            
            if (isDone) {
                markDoneMainBtn.classList.add('active', 'done-active');
                markDoneMainBtn.disabled = true;
            } else {
                markDoneMainBtn.classList.remove('active', 'done-active');
                markDoneMainBtn.disabled = false;
            }
        }

        // ========== DONE MODAL ==========
        const doneModal = document.getElementById('done-modal');
        const doneModalClose = document.getElementById('done-modal-close');
        const doneWordsList = document.getElementById('done-words-list');
        const doneStoriesList = document.getElementById('done-stories-list');

        function openDoneModal() {
            renderDoneLists();
            
            // Show appropriate tab based on current mode
            const tabs = document.querySelectorAll('#done-modal .done-modal-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (currentAppMode === 'stories') {
                tabs[1].classList.add('active');
                doneWordsList.style.display = 'none';
                doneStoriesList.style.display = 'block';
            } else {
                tabs[0].classList.add('active');
                doneWordsList.style.display = 'block';
                doneStoriesList.style.display = 'none';
            }
            
            doneModal.classList.add('active');
        }

        function closeDoneModal() {
            doneModal.classList.remove('active');
        }

        function renderDoneLists() {
            // Render words
            if (doneWords.size === 0) {
                doneWordsList.innerHTML = '<p class="done-empty">Brak załatwionych słów</p>';
            } else {
                doneWordsList.innerHTML = [...doneWords].map(word => `
                    <div class="done-item">
                        <span class="done-item-text">${word}</span>
                        <button class="done-item-remove" onclick="removeDoneWord('${word}')" title="Usuń">×</button>
                    </div>
                `).join('');
            }
            
            // Render stories
            if (doneStories.size === 0) {
                doneStoriesList.innerHTML = '<p class="done-empty">Brak załatwionych historii</p>';
            } else {
                doneStoriesList.innerHTML = [...doneStories].map((story, i) => `
                    <div class="done-item">
                        <span class="done-item-text story">${story.substring(0, 60)}...</span>
                        <button class="done-item-remove" onclick="removeDoneStory(${i})" title="Usuń">×</button>
                    </div>
                `).join('');
            }
        }

        window.removeDoneWord = function(word) {
            doneWords.delete(word);
            saveSavedWritings();
            renderDoneLists();
            updateDoneCounter();
            updateDoneButtonState();
            renderSavedWritings();
            
            // Update current word if it's the same
            if (currentWord === word) {
                wordInner.classList.remove('done');
            }
        };

        window.removeDoneStory = function(index) {
            const storiesArray = [...doneStories];
            const story = storiesArray[index];
            doneStories.delete(story);
            saveSavedWritings();
            renderDoneLists();
            updateDoneCounter();
            updateDoneButtonState();
            
            // Update current word if it's the same
            if (currentWord === story) {
                wordInner.classList.remove('done');
            }
        };

        // Done Modal tabs
        document.querySelectorAll('#done-modal .done-modal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('#done-modal .done-modal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (tab.dataset.tab === 'words') {
                    doneWordsList.style.display = 'block';
                    doneStoriesList.style.display = 'none';
                } else {
                    doneWordsList.style.display = 'none';
                    doneStoriesList.style.display = 'block';
                }
            });
        });

        document.getElementById('done-counter').addEventListener('click', openDoneModal);
        doneModalClose.addEventListener('click', closeDoneModal);
        doneModal.addEventListener('click', (e) => {
            if (e.target === doneModal) closeDoneModal();
        });

        // ========== ALL ITEMS MODAL ==========
        const allItemsModal = document.getElementById('all-items-modal');
        const allItemsModalClose = document.getElementById('all-items-modal-close');
        const allWordsList = document.getElementById('all-words-list');
        const allStoriesList = document.getElementById('all-stories-list');

        function openAllItemsModal() {
            renderAllItemsLists();
            
            // Show appropriate tab based on current mode
            const tabs = document.querySelectorAll('#all-items-modal .done-modal-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (currentAppMode === 'stories') {
                tabs[1].classList.add('active');
                allWordsList.style.display = 'none';
                allStoriesList.style.display = 'block';
            } else {
                tabs[0].classList.add('active');
                allWordsList.style.display = 'block';
                allStoriesList.style.display = 'none';
            }
            
            allItemsModal.classList.add('active');
        }

        function closeAllItemsModal() {
            allItemsModal.classList.remove('active');
        }

        function renderAllItemsLists() {
            // Update counts
            document.getElementById('words-count').textContent = `(${words.length})`;
            document.getElementById('stories-count').textContent = `(${storyStarters.length})`;
            
            // Render all words
            allWordsList.innerHTML = words.map((word, i) => `
                <div class="all-item ${doneWords.has(word) ? 'done' : ''}">
                    <span class="all-item-text" onclick="selectWord('${word}')">${word}</span>
                    <button class="all-item-toggle" onclick="toggleWordDone('${word}')" title="${doneWords.has(word) ? 'Usuń z załatwionych' : 'Oznacz jako załatwione'}">
                        ${doneWords.has(word) ? '×' : '✓'}
                    </button>
                </div>
            `).join('');
            
            // Render all stories
            allStoriesList.innerHTML = storyStarters.map((story, i) => `
                <div class="all-item ${doneStories.has(story) ? 'done' : ''}">
                    <span class="all-item-text story" onclick="selectStory(${i})">${story}</span>
                    <button class="all-item-toggle" onclick="toggleStoryDone(${i})" title="${doneStories.has(story) ? 'Usuń z załatwionych' : 'Oznacz jako załatwione'}">
                        ${doneStories.has(story) ? '×' : '✓'}
                    </button>
                </div>
            `).join('');
        }

        window.toggleWordDone = function(word) {
            if (doneWords.has(word)) {
                doneWords.delete(word);
            } else {
                doneWords.add(word);
            }
            saveSavedWritings();
            renderAllItemsLists();
            updateDoneCounter();
            updateDoneButtonState();
            renderSavedWritings();
            
            if (currentWord === word) {
                wordInner.classList.toggle('done', doneWords.has(word));
            }
        };

        window.toggleStoryDone = function(index) {
            const story = storyStarters[index];
            if (doneStories.has(story)) {
                doneStories.delete(story);
            } else {
                doneStories.add(story);
            }
            saveSavedWritings();
            renderAllItemsLists();
            updateDoneCounter();
            updateDoneButtonState();
            
            if (currentWord === story) {
                wordInner.classList.toggle('done', doneStories.has(story));
            }
        };

        window.selectWord = function(word) {
            closeAllItemsModal();
            
            // Switch to words mode if needed
            if (currentAppMode !== 'words') {
                switchAppMode('words');
            }
            
            // Set the word
            currentWord = word;
            drawnWords.add(word);
            
            // Hide intro
            if (introInfo && !introInfo.classList.contains('hidden')) {
                introInfo.classList.add('hidden');
            }
            
            // Update display
            wordInner.textContent = currentWord;
            wordInner.classList.remove('hiding', 'story-mode');
            if (doneWords.has(currentWord)) {
                wordInner.classList.add('done');
            } else {
                wordInner.classList.remove('done');
            }
            
            setTimeout(() => {
                createParticles();
                wordInner.classList.add('revealed');
                wordGlow.classList.add('active');
                actionButtons.style.display = 'flex';
                updateDoneButtonState();
                frame.classList.add('visible');
            }, 100);
        };

        window.selectStory = function(index) {
            closeAllItemsModal();
            
            // Switch to stories mode if needed
            if (currentAppMode !== 'stories') {
                switchAppMode('stories');
            }
            
            const story = storyStarters[index];
            currentWord = story;
            drawnStories.add(story);
            
            // Hide intro
            if (introInfo && !introInfo.classList.contains('hidden')) {
                introInfo.classList.add('hidden');
            }
            
            // Update display
            wordInner.textContent = currentWord;
            wordInner.classList.remove('hiding');
            wordInner.classList.add('story-mode');
            wordStage.classList.add('story-active');
            speakBtn.style.display = 'none';
            
            if (doneStories.has(currentWord)) {
                wordInner.classList.add('done');
            } else {
                wordInner.classList.remove('done');
            }
            
            setTimeout(() => {
                createParticles();
                wordInner.classList.add('revealed');
                wordGlow.classList.add('active');
                actionButtons.style.display = 'flex';
                markDoneMainBtn.style.display = '';
                updateDoneButtonState();
                frame.classList.add('visible');
            }, 100);
        };

        // All items modal tabs
        document.querySelectorAll('#all-items-modal .done-modal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('#all-items-modal .done-modal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (tab.dataset.tab === 'all-words') {
                    allWordsList.style.display = 'block';
                    allStoriesList.style.display = 'none';
                } else {
                    allWordsList.style.display = 'none';
                    allStoriesList.style.display = 'block';
                }
            });
        });

        document.querySelector('.title').addEventListener('click', openAllItemsModal);
        allItemsModalClose.addEventListener('click', closeAllItemsModal);
        allItemsModal.addEventListener('click', (e) => {
            if (e.target === allItemsModal) closeAllItemsModal();
        });

        function createParticles() {
            particles.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = (i / 12) * Math.PI * 2;
                const distance = 50 + Math.random() * 50;
                particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.animation = `particleBurst 0.8s ease-out ${i * 0.02}s forwards`;
                particles.appendChild(particle);
            }
        }

        function speakWord() {
            if (!currentWord) return;
            const utterance = new SpeechSynthesisUtterance(currentWord);
            utterance.lang = 'pl-PL';
            utterance.rate = 0.8;
            const voices = speechSynthesis.getVoices();
            const polishVoice = voices.find(v => v.lang.startsWith('pl'));
            if (polishVoice) utterance.voice = polishVoice;
            speechSynthesis.speak(utterance);
        }

        function toggleAutoSpeak() {
            autoSpeak = !autoSpeak;
            speakBtn.classList.toggle('active', autoSpeak);
        }

        async function drawWord() {
            if (isAnimating) return;
            isAnimating = true;

            if (wordInner.textContent) {
                wordInner.classList.remove('revealed', 'done', 'story-mode');
                wordInner.classList.add('hiding');
                wordGlow.classList.remove('active');
                frame.classList.remove('visible');
                await new Promise(r => setTimeout(r, 400));
                wordInner.classList.remove('hiding');
            }

            // Hide intro info after first word
            if (introInfo && !introInfo.classList.contains('hidden')) {
                introInfo.classList.add('hidden');
            }
            
            if (currentAppMode === 'stories') {
                // Story mode
                currentWord = getRandomStory();
                
                // Handle case when all stories are done
                if (currentWord === null) {
                    wordInner.textContent = 'wszystkie historie załatwione!';
                    wordInner.classList.add('revealed', 'story-mode');
                    wordGlow.classList.add('active');
                    wordStage.classList.add('story-active');
                    actionButtons.style.display = 'none';
                    setTimeout(() => isAnimating = false, 800);
                    return;
                }
                
                drawnStories.add(currentWord);
                wordInner.textContent = currentWord;
                wordInner.classList.add('story-mode');
                wordStage.classList.add('story-active');
                
                // Show done indicator if story is already done
                if (doneStories.has(currentWord)) {
                    wordInner.classList.add('done');
                }
                
                // Show done button, hide speak button in story mode
                markDoneMainBtn.style.display = '';
                speakBtn.style.display = 'none';
                updateDoneButtonState();
            } else {
                // Words mode
                wordStage.classList.remove('story-active');
                markDoneMainBtn.style.display = '';
                speakBtn.style.display = '';
                currentWord = getRandomWord();
                
                // Handle case when all words are done
                if (currentWord === null) {
                    wordInner.textContent = 'wszystkie załatwione!';
                    wordInner.classList.add('revealed');
                    wordGlow.classList.add('active');
                    actionButtons.style.display = 'none';
                    setTimeout(() => isAnimating = false, 800);
                    return;
                }
                
                drawnWords.add(currentWord);
                wordInner.textContent = currentWord;
                
                // Show done indicator if word is already done
                if (doneWords.has(currentWord)) {
                    wordInner.classList.add('done');
                }
                
                // Show done button in words mode
                markDoneMainBtn.style.display = '';
                updateDoneButtonState();
            }

            await new Promise(r => setTimeout(r, 100));
            createParticles();
            wordInner.classList.add('revealed');
            wordGlow.classList.add('active');
            
            // Show action buttons after first word
            actionButtons.style.display = 'flex';
            
            if (autoSpeak && currentAppMode === 'words') setTimeout(() => speakWord(), 300);
            setTimeout(() => frame.classList.add('visible'), 300);
            setTimeout(() => isAnimating = false, 800);
        }

        // Mode switching
        function switchAppMode(mode) {
            if (mode === currentAppMode) return;
            currentAppMode = mode;
            
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });
            
            // Update counter for new mode
            updateDoneCounter();
            
            // Update intro text
            const introText = document.querySelector('.intro-text');
            if (introText) {
                if (mode === 'stories') {
                    introText.innerHTML = 'Wylosuj początek historii i <strong>dokończ</strong> ją po swojemu.';
                } else {
                    introText.innerHTML = 'Wylosuj słowo, a następnie <strong>pisz</strong> lub <strong>nagrywaj</strong> swoje myśli.';
                }
            }
            
            // Reset word display
            wordInner.textContent = '';
            wordInner.classList.remove('revealed', 'done', 'story-mode');
            wordStage.classList.remove('story-active');
            wordGlow.classList.remove('active');
            frame.classList.remove('visible');
            actionButtons.style.display = 'none';
            
            // Reset button visibility
            speakBtn.style.display = mode === 'stories' ? 'none' : '';
            
            // Show intro again
            if (introInfo) {
                introInfo.classList.remove('hidden');
            }
        }

        // Event listeners for mode toggle
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => switchAppMode(tab.dataset.mode));
        });

        // Event listeners for word mode
        drawBtn.addEventListener('click', drawWord);
        speakBtn.addEventListener('click', toggleAutoSpeak);
        wordStage.addEventListener('click', (e) => {
            if (currentMode === 'word' && !e.target.closest('.btn')) drawWord();
        });

        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }

        // ========== MODE SWITCHING ==========
        function enterWritingMode() {
            if (!currentWord) return;
            currentMode = 'writing';
            
            // Slow transitions
            header.classList.add('hidden');
            controls.classList.add('hidden');
            document.getElementById('mode-toggle').classList.add('hidden');
            bgLayer.classList.add('dimmed');
            wordStage.classList.add('compact');
            
            setTimeout(() => {
                document.getElementById('writing-panel').classList.add('active');
            }, 500);
        }

        function exitWritingMode() {
            currentMode = 'word';
            
            document.getElementById('writing-panel').classList.remove('active');
            document.getElementById('writing-setup').classList.remove('hidden');
            document.getElementById('writing-editor').classList.remove('active');
            document.getElementById('writing-complete').classList.remove('active');
            
            setTimeout(() => {
                header.classList.remove('hidden');
                controls.classList.remove('hidden');
                document.getElementById('mode-toggle').classList.remove('hidden');
                bgLayer.classList.remove('dimmed');
                wordStage.classList.remove('compact');
            }, 300);
        }

        function enterRecordingMode() {
            if (!currentWord) return;
            currentMode = 'recording';
            
            header.classList.add('hidden');
            controls.classList.add('hidden');
            document.getElementById('mode-toggle').classList.add('hidden');
            
            setTimeout(() => {
                document.getElementById('recording-panel').classList.add('active');
            }, 500);
        }

        function exitRecordingMode() {
            currentMode = 'word';
            
            document.getElementById('recording-panel').classList.remove('active');
            
            setTimeout(() => {
                header.classList.remove('hidden');
                controls.classList.remove('hidden');
                document.getElementById('mode-toggle').classList.remove('hidden');
            }, 300);
        }

        writeBtn.addEventListener('click', enterWritingMode);
        recordModeBtn.addEventListener('click', enterRecordingMode);
        markDoneMainBtn.addEventListener('click', markWordAsDone);
        document.getElementById('cancel-writing-btn').addEventListener('click', exitWritingMode);
        document.getElementById('back-to-word-btn').addEventListener('click', exitWritingMode);
        document.getElementById('back-from-record-btn').addEventListener('click', exitRecordingMode);

        // ========== WRITING MODULE ==========
        let writingInterval = null;
        let idleInterval = null;
        let writingTimeLeft = 0;
        let idleTime = 0;
        let lastBadgeCount = 0;
        const IDLE_DELETE = 8;

        const writingSetup = document.getElementById('writing-setup');
        const writingEditor = document.getElementById('writing-editor');
        const writingComplete = document.getElementById('writing-complete');
        const writingTimeInput = document.getElementById('writing-time');
        const timeValueDisplay = document.getElementById('time-value');
        const startWritingBtn = document.getElementById('start-writing-btn');
        const writingTimerDisplay = document.getElementById('writing-timer');
        const wordCountDisplay = document.getElementById('word-count');
        const editorTextarea = document.getElementById('editor-textarea');
        const dangerIndicator = document.getElementById('danger-indicator');
        const completeStats = document.getElementById('complete-stats');
        const savedTextPreview = document.getElementById('saved-text-preview');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const newSessionBtn = document.getElementById('new-session-btn');
        const writingDots = document.getElementById('writing-dots');

        // Add writing dot
        function addWritingDot() {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            writingDots.appendChild(dot);
        }

        // Check for new dots
        function checkWritingDots(wordCount) {
            const dotThreshold = 50;
            const currentDotLevel = Math.floor(wordCount / dotThreshold);
            
            if (currentDotLevel > lastBadgeCount) {
                for (let i = lastBadgeCount + 1; i <= currentDotLevel; i++) {
                    setTimeout(() => {
                        addWritingDot();
                    }, (i - lastBadgeCount - 1) * 150);
                }
                lastBadgeCount = currentDotLevel;
            }
        }

        // Slider functionality
        function getMinutyForm(n) {
            if (n === 1) return 'minuta';
            if (n >= 2 && n <= 4) return 'minuty';
            return 'minut';
        }

        function updateSlider() {
            const value = parseInt(writingTimeInput.value);
            const min = parseInt(writingTimeInput.min);
            const max = parseInt(writingTimeInput.max);
            const progress = ((value - min) / (max - min)) * 100;
            writingTimeInput.style.setProperty('--slider-progress', progress + '%');
            timeValueDisplay.textContent = value;
            document.querySelector('.time-unit').textContent = getMinutyForm(value);
        }

        writingTimeInput.addEventListener('input', updateSlider);
        updateSlider(); // Initialize

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateWordCount() {
            const text = editorTextarea.value.trim();
            const count = text ? text.split(/\s+/).length : 0;
            wordCountDisplay.textContent = `${count} słów`;
            checkWritingDots(count);
            return count;
        }

        function resetIdleTimer() {
            idleTime = 0;
            editorTextarea.style.setProperty('--idle-progress', '0');
            editorTextarea.classList.remove('fading');
            dangerIndicator.classList.remove('visible');
        }

        function checkIdle() {
            idleTime += 0.05;
            
            // Gradual progress from 0 to 1 over IDLE_DELETE seconds
            const progress = Math.min(idleTime / IDLE_DELETE, 1);
            editorTextarea.style.setProperty('--idle-progress', progress.toString());
            
            if (progress > 0.5) {
                editorTextarea.classList.add('fading');
            }
            
            if (progress > 0.7) {
                dangerIndicator.classList.add('visible');
            }
            
            if (idleTime >= IDLE_DELETE) {
                editorTextarea.value = '';
                updateWordCount();
                resetIdleTimer();
            }
        }

        function startWriting() {
            const minutes = parseInt(writingTimeInput.value) || 5;
            writingTimeLeft = minutes * 60;
            
            // Reset dots
            lastBadgeCount = 0;
            writingDots.innerHTML = '';
            
            writingSetup.classList.add('hidden');
            writingEditor.classList.add('active');
            editorTextarea.value = '';
            editorTextarea.focus();
            updateWordCount();
            resetIdleTimer();
            
            writingTimerDisplay.textContent = formatTime(writingTimeLeft);
            
            writingInterval = setInterval(() => {
                writingTimeLeft--;
                writingTimerDisplay.textContent = formatTime(writingTimeLeft);
                
                if (writingTimeLeft <= 0) {
                    endWriting(true);
                }
            }, 1000);
            
            idleInterval = setInterval(checkIdle, 50);
        }

        function endWriting(completed) {
            clearInterval(writingInterval);
            clearInterval(idleInterval);
            
            const finalText = editorTextarea.value;
            currentWritingText = finalText; // Store for saving
            const totalWords = updateWordCount();
            
            writingEditor.classList.remove('active');
            
            setTimeout(() => {
                writingComplete.classList.add('active');
                
                // Reset mark done button
                const markDoneBtn = document.getElementById('mark-done-btn');
                if (markDoneBtn) {
                    if (doneWords.has(currentWord)) {
                        markDoneBtn.querySelector('.btn-text').textContent = '✓ Załatwione!';
                        markDoneBtn.disabled = true;
                    } else {
                        markDoneBtn.querySelector('.btn-text').textContent = '✓ Załatwione';
                        markDoneBtn.disabled = false;
                    }
                }
            }, 300);
            
            const minutes = parseInt(writingTimeInput.value) || 5;
            completeStats.innerHTML = `
                Słowo: <em>${currentWord}</em><br>
                Czas: ${minutes} min · ${totalWords} słów
            `;
            savedTextPreview.textContent = finalText || '(brak tekstu)';
        }

        function resetWriting() {
            writingComplete.classList.remove('active');
            setTimeout(() => {
                writingSetup.classList.remove('hidden');
            }, 300);
            resetIdleTimer();
        }

        startWritingBtn.addEventListener('click', startWriting);
        newSessionBtn.addEventListener('click', resetWriting);
        
        copyTextBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(savedTextPreview.textContent);
            copyTextBtn.querySelector('.btn-text').textContent = 'Skopiowano!';
            setTimeout(() => {
                copyTextBtn.querySelector('.btn-text').textContent = 'Kopiuj';
            }, 2000);
        });

        // Save text button
        document.getElementById('save-text-btn').addEventListener('click', saveCurrentWriting);
        
        // Mark word as done button
        document.getElementById('mark-done-btn').addEventListener('click', markWordAsDone);

        editorTextarea.addEventListener('input', () => {
            resetIdleTimer();
            updateWordCount();
        });

        editorTextarea.addEventListener('keydown', resetIdleTimer);
        
        // Load saved writings on init
        loadSavedWritings();

        // ========== RECORDING MODULE ==========
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isPaused = false;
        let recordingStartTime = null;
        let recordingTimerInterval = null;
        let recordings = [];
        let audioStream = null;
        let lastRecordingMinute = 0;
        let totalPausedTime = 0;
        let pauseStartTime = null;

        const micVisualizer = document.getElementById('mic-visualizer');
        const recordingTimerDisplay = document.getElementById('recording-timer');
        const recordBtn = document.getElementById('record-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const pauseIcon = document.getElementById('pause-icon');
        const recordingsList = document.getElementById('recordings-list');
        const recordingDots = document.getElementById('recording-dots');

        // Add recording dot
        function addRecordingDot() {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            recordingDots.appendChild(dot);
        }

        // Check recording time for dots
        function checkRecordingDots() {
            const elapsed = getRecordingElapsed();
            const currentMinute = Math.floor(elapsed / 60000);
            
            if (currentMinute > lastRecordingMinute) {
                for (let i = lastRecordingMinute + 1; i <= currentMinute; i++) {
                    addRecordingDot();
                }
                lastRecordingMinute = currentMinute;
            }
        }

        // Get elapsed recording time (excluding pauses)
        function getRecordingElapsed() {
            if (!recordingStartTime) return 0;
            let elapsed = Date.now() - recordingStartTime - totalPausedTime;
            if (isPaused && pauseStartTime) {
                elapsed -= (Date.now() - pauseStartTime);
            }
            return Math.max(0, elapsed);
        }

        function loadRecordings() {
            try {
                const saved = localStorage.getItem('workshopRecordings');
                if (saved) {
                    recordings = JSON.parse(saved);
                    renderRecordings();
                }
            } catch (e) {
                console.error('Błąd wczytywania nagrań:', e);
                recordings = [];
            }
        }

        function saveRecordings() {
            try {
                // Keep only last 10 recordings to avoid localStorage limits
                const toSave = recordings.slice(0, 10);
                localStorage.setItem('workshopRecordings', JSON.stringify(toSave));
            } catch (e) {
                console.error('Błąd zapisywania nagrań:', e);
                alert('Nie można zapisać nagrania. Pamięć przeglądarki może być pełna.');
            }
        }

        function renderRecordings() {
            if (recordings.length === 0) {
                recordingsList.innerHTML = '<p class="no-recordings">Brak nagrań</p>';
                return;
            }

            recordingsList.innerHTML = recordings.map((rec, i) => `
                <div class="recording-item">
                    <div class="recording-info">
                        <span class="recording-name">${rec.word || 'Nagranie'}</span>
                        <span class="recording-date">${rec.date} · ${rec.duration}</span>
                    </div>
                    <div class="recording-actions">
                        <button class="btn-tiny" onclick="playRecording(${i})" title="Odtwórz">
                            <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        </button>
                        <button class="btn-tiny" onclick="downloadRecording(${i})" title="Pobierz">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                        <button class="btn-tiny" onclick="deleteRecording(${i})" title="Usuń">
                            <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.playRecording = function(index) {
            try {
                const audio = new Audio(recordings[index].data);
                audio.play();
            } catch (e) {
                alert('Nie można odtworzyć nagrania.');
            }
        };

        window.downloadRecording = function(index) {
            try {
                const rec = recordings[index];
                const link = document.createElement('a');
                link.href = rec.data;
                link.download = `${rec.word || 'nagranie'}-${Date.now()}.webm`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                alert('Nie można pobrać nagrania.');
            }
        };

        window.deleteRecording = function(index) {
            recordings.splice(index, 1);
            saveRecordings();
            renderRecordings();
        };

        function formatRecordingTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            isRecording = false;
            isPaused = false;
            micVisualizer.classList.remove('recording');
            micVisualizer.classList.remove('paused');
            recordBtn.querySelector('.btn-text').textContent = 'Nagraj';
            pauseBtn.style.display = 'none';
            clearInterval(recordingTimerInterval);
        }

        function togglePause() {
            if (!isRecording) return;
            
            if (isPaused) {
                // Resume
                mediaRecorder.resume();
                isPaused = false;
                totalPausedTime += Date.now() - pauseStartTime;
                pauseStartTime = null;
                micVisualizer.classList.remove('paused');
                micVisualizer.classList.add('recording');
                pauseIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
            } else {
                // Pause
                mediaRecorder.pause();
                isPaused = true;
                pauseStartTime = Date.now();
                micVisualizer.classList.remove('recording');
                micVisualizer.classList.add('paused');
                pauseIcon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
            }
        }

        async function startRecording() {
            try {
                // Check if getUserMedia is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Twoja przeglądarka nie obsługuje nagrywania audio. Spróbuj otworzyć tę stronę w Chrome, Firefox lub Safari.');
                    return;
                }

                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                // Use WAV-compatible format for better MP3 conversion
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                }

                mediaRecorder = new MediaRecorder(audioStream, { mimeType });
                audioChunks = [];
                recordingStartTime = Date.now();
                totalPausedTime = 0;
                pauseStartTime = null;
                isPaused = false;

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const duration = getRecordingElapsed();
                    const blob = new Blob(audioChunks, { type: mimeType });
                    
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        recordings.unshift({
                            word: currentWord,
                            data: reader.result,
                            date: new Date().toLocaleDateString('pl-PL'),
                            duration: formatRecordingTime(duration)
                        });
                        saveRecordings();
                        renderRecordings();
                    };
                    reader.readAsDataURL(blob);
                    
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                };

                mediaRecorder.onerror = (e) => {
                    console.error('MediaRecorder error:', e);
                    stopRecording();
                    alert('Wystąpił błąd podczas nagrywania.');
                };

                mediaRecorder.start(1000); // Collect data every second
                isRecording = true;
                micVisualizer.classList.add('recording');
                recordBtn.querySelector('.btn-text').textContent = 'Zatrzymaj';
                pauseBtn.style.display = 'flex';
                
                // Reset dots
                lastRecordingMinute = 0;
                recordingDots.innerHTML = '';
                
                recordingTimerInterval = setInterval(() => {
                    if (!isPaused) {
                        recordingTimerDisplay.textContent = formatRecordingTime(getRecordingElapsed());
                        checkRecordingDots();
                    }
                }, 100);

            } catch (err) {
                console.error('Recording error:', err);
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert('Dostęp do mikrofonu został zablokowany. Kliknij ikonę kłódki w pasku adresu i zezwól na dostęp do mikrofonu.');
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    alert('Nie znaleziono mikrofonu. Upewnij się, że mikrofon jest podłączony.');
                } else if (err.name === 'NotSupportedError') {
                    alert('Nagrywanie audio nie jest obsługiwane w tym kontekście. Spróbuj otworzyć stronę bezpośrednio (nie w iframe).');
                } else {
                    alert('Nie można uzyskać dostępu do mikrofonu: ' + err.message);
                }
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        pauseBtn.addEventListener('click', togglePause);
        recordBtn.addEventListener('click', toggleRecording);
        loadRecordings();
    </script>
</body>
</html>
